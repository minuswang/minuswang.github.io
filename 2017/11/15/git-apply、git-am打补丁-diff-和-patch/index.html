<!DOCTYPE html>
<html lang="">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="git apply、git am打补丁.diff 和 .patch"/>








  <link rel="alternate" href="/default" title="Minus Wang">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="http://minus.wang/2017/11/15/git-apply、git-am打补丁-diff-和-patch/"/>


<meta name="description" content="生成patch：  git format-patch -M master 生成指定patch，0163bed3bf59ae74c36cc5138b4c24f1556d8304是commit id，-1是指从当前id开始，向下提交次数，包含此次且计数从1开始。也就是说，我想要打出0163bed3bf59ae74c36cc5138b4c24f1556d8304当前的patch，则：git forma">
<meta property="og:type" content="article">
<meta property="og:title" content="git apply、git am打补丁.diff 和 .patch">
<meta property="og:url" content="http://minus.wang/2017/11/15/git-apply、git-am打补丁-diff-和-patch/index.html">
<meta property="og:site_name" content="Minus Wang">
<meta property="og:description" content="生成patch：  git format-patch -M master 生成指定patch，0163bed3bf59ae74c36cc5138b4c24f1556d8304是commit id，-1是指从当前id开始，向下提交次数，包含此次且计数从1开始。也就是说，我想要打出0163bed3bf59ae74c36cc5138b4c24f1556d8304当前的patch，则：git forma">
<meta property="og:updated_time" content="2017-11-15T10:15:55.612Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="git apply、git am打补丁.diff 和 .patch">
<meta name="twitter:description" content="生成patch：  git format-patch -M master 生成指定patch，0163bed3bf59ae74c36cc5138b4c24f1556d8304是commit id，-1是指从当前id开始，向下提交次数，包含此次且计数从1开始。也就是说，我想要打出0163bed3bf59ae74c36cc5138b4c24f1556d8304当前的patch，则：git forma">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> git apply、git am打补丁.diff 和 .patch - Minus Wang </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">Minus Wang</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                Me
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/daohang">
                            
                            
                                Site
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/notes">
                            
                            
                                Note
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          git apply、git am打补丁.diff 和 .patch
        
      </h1>

      <time class="post-time">
          Nov 15 2017
      </time>
    </header>



    
            <div class="post-content">
            <blockquote>
<p>生成patch：</p>
</blockquote>
<p>git format-patch -M master</p>
<p>生成指定patch，0163bed3bf59ae74c36cc5138b4c24f1556d8304是commit id，-1是指从当前id开始，向下提交次数，包含此次且计数从1开始。<br>也就是说，我想要打出0163bed3bf59ae74c36cc5138b4c24f1556d8304当前的patch，则：<br>git format-patch 0163bed3bf59ae74c36cc5138b4c24f1556d8304 -1<br>想要打出0163bed3bf59ae74c36cc5138b4c24f1556d8304和它之前的一次提交的patch，则：<br>git format-patch 0163bed3bf59ae74c36cc5138b4c24f1556d8304 -2</p>
<blockquote>
<p>生成diff：</p>
</blockquote>
<p>git diff (id1) (id2) –binary –(path) &gt; 目标文件路径<br>比如要生成frameworks/base/下的diff，保存到~/gittest/下的f_b.diff：（注意：旧的id1在前）<br>git diff 206b47c132a80870c06d87c69a548bbfeebecd2d b5ce3e4ebe9503e370d734cecc12482bca023fdf –binary – frameworks/base/ &gt; ~/gittest/f_b.diff</p>
<blockquote>
<p>打入 patch / diff：</p>
</blockquote>
<p>git apply xxx.patch<br>git apply xxx.diff</p>
<blockquote>
<p>检查 patch / diff：</p>
</blockquote>
<p>git apply –check xxx.patch<br>git apply –check xxx.diff</p>
<p>若git和需要打patch的文件不在一个目录：(git在framework下，patch要打入frameworks/base/下)<br>git apply –check –directory=base/ xxx.patch<br>git apply –directory=base/ xxx.patch<br>git am 后面会说到，以及生产patch和打入patch的一些命令参数</p>
<p>我们创建一个文件夹，git init一下，模拟diff / patch源环境<br>$ mkdir gittest<br>$ git init<br>然后创建一个空文件 test，然后首次提交<br>$ touch test<br>$ git add .<br>$ git commit -m “test init”<br>在里面加入11111，add，commit（add 11111）一次；<br>在里面加入22222，add，commit（add 22222）一次；<br>…<br>在里面加入55555，add，commit（add 55555）一次；<br>一共提交5次，可以看到提交了5次。</p>
<p>gitk<br>生成patch / diff 文件（我们单独建一个文件夹来存patch和diff –&gt; ~/patch/patch/）：</p>
<p>在工作中，二者选一个就可以，看自己的需求。<br>patch相对于diff，多了提交记录，也就是说可以原封不动的把他人commit内容写上去，但是操作比diff麻烦一些</p>
<p>生成patch：<br>我们记录一下最新的commit id ： 21ebfb1ef6a0a9b56d46036c036e8377b56b2da5，有5次提交。</p>
<p>$ git format-patch 21ebfb1ef6a0a9b56d46036c036e8377b56b2da5 -5</p>
<p>git patch</p>
<p>生成了包含当前id和之前的4个id的patch，一共5个，命名也有规律000X+commit的内容.patch<br>我们把这5个移到~/patch/patch/中。</p>
<p>生成diff：<br>我们记录要生成diff的区间，!!包上不包下!!，</p>
<p>就是说我要生成 11111~55555的diff<br>id1 是 test init的id；1cf68afcf3e089a349c8ee534dc3ff44d11a6624<br>id2是add 55555的id。21ebfb1ef6a0a9b56d46036c036e8377b56b2da5<br>$ git diff 1cf68afcf3e089a349c8ee534dc3ff44d11a6624 21ebfb1ef6a0a9b56d46036c036e8377b56b2da5 –binary – . &gt; ~/patch/patch/test.diff</p>
<p>diff 多次提交可以是一个文件，但是patch不行，因为它里面有commit记录！</p>
<p>打 patch / diff 补丁（无冲突）：</p>
<p>我们在当前目录创建一个需要打补丁的文件夹(gittest1)，里面也有一个空的test文件。<br>然后我们把patch/diff打入gittest1/test。<br>执行最开始的1、2即可，改一下文件夹名称就ok</p>
<p>gittest1<br>打patch（不包含commit内容）<br>检查patch是否可用，没显示文字，就说明可用，且无冲突；<br>git apply –check ~/patch/patch/0001-add-11111.patch<br>一般检查一个就可以。<br>打入patch，可以批量，也可以单个。<br>git apply ~/patch/patch/*.patch<br>肯定会成功，因为没有冲突。我们查看一下<br>git diff</p>
<p>git diff</p>
<p>5个patch都打上去了，接着就可以 git add / commit提交了。但是这样没有commit记录。</p>
<p>打patch（包含commit内容 git am） git checkout . 撤销一下<br>检查patch是否可用，没显示文字，就说明可用，且无冲突；<br>git apply –check ~/patch/patch/0001-add-11111.patch<br>打入patch，可以批量，也可以单个。<br> git am ~/patch/patch/*.patch<br>肯定会成功，因为没有冲突。我们查看一下</p>
<p>gitk</p>
<p>gitk</p>
<p>我们发现已经自动commit，不用add、commit，可以直接push。</p>
<p>打diff  git reset –hard 4c6eb312e94214a5f34fa3f119382ace647b1b3c 撤销一下<br>检查diff是否可用，没显示文字，就说明可用，且无冲突；<br>git apply –check ~/patch/patch/test.diff<br>打入diff;<br>git apply ~/patch/patch/test.diff<br>肯定会成功，因为没有冲突。我们查看一下<br>git diff</p>
<p>git diff</p>
<p>接着就可以 git add / commit提交了。但是这样没有commit记录。</p>
<p>打 patch / diff 补丁（有冲突）：</p>
<p>我们还原gittest1/test的初始状态，然后修改一下test文件，写入00000,，然后add、commit。</p>
<p>add 00000<br>打patch</p>
<p>检查patch是否可用，没显示文字，就说明可用，且无冲突；<br>git apply –check ~/patch/patch/0001-add-11111.patch<br>error: 打补丁失败：test:0<br>error: test：补丁未应用<br>说明是可以用，但是有冲突。<br>打入patch，可以批量，也可以单个。</p>
<p>因为在check的时候知道已经有冲突了，就不好用apply来打patch，如果一定要用的话，建议一个一个apply，所以很麻烦，不如用diff。<br>在这里要用到 git am<br> git am ~/patch/patch/*.patch</p>
<p>正应用：add 11111<br>error: 打补丁失败：test:0<br>error: test：补丁未应用<br>补丁失败于 0001 add 11111<br>失败的补丁文件副本位于：<br>/home/deshui/yudeshui/log/gittest1/.git/rebase-apply/patch<br>当您解决了此问题后，执行 “git am –continue”。<br>如果您想跳过此补丁，则执行 “git am –skip”。<br>要恢复原分支并停止打补丁，执行 “git am –abort”。<br>这行话告诉你，patch冲突了，但是有三个选项 git am –continue、git am –skip、git am –abort<br>这时候不要动！不要动！不要动！</p>
<p>解决冲突。<br>我们 gedit test，在里面手动加入11111，因为我们加入了00000，导致错行，所以接下来的4个patch都会有冲突。<br>提交记录。<br>git add test<br>git am –continue<br>正应用：add 11111<br>正应用：add 22222<br>error: 打补丁失败：test:1<br>error: test：补丁未应用<br>补丁失败于 0002 add 22222<br>失败的补丁文件副本位于：<br>~/gittest1/.git/rebase-apply/patch<br>当您解决了此问题后，执行 “git am –continue”。<br>如果您想跳过此补丁，则执行 “git am –skip”。<br>要恢复原分支并停止打补丁，执行 “git am –abort”。<br>我们gitk一下，发现已经commit已经有add 11111的记录了！<br>同上操作，一直修改到44444<br>git add test<br>git am –continue<br>正应用：add 44444<br>正应用：add 55555<br>这样就完整的解决冲突，保留commit了。</p>
<p>git am finish<br>打diff  git reset –hard 0050cda7f22df985d79b9b98da9bfc282ea10ef1 撤销到add 00000<br>检查diff是否可用，肯定有冲突。<br>git apply –check ~/patch/patch/test.diff<br>error: 打补丁失败：test:0<br>error: test：补丁未应用<br>打入diff;<br>git apply –reject –ignore-whitespace ~/patch/patch/test.diff 2&gt;&amp;1 | tee ~/patch/patch/testdiff.log<br>这里reject是生成一个.rej的文件，是一个差异文件。<br>ignore-whitespace是忽略多余的空格。<br>2&gt;&amp;1是值错误信息<br>tee 错误信息输出到控制台<br>~/patch/patch/testdiff.log 错误信息保存在这个文件里<br><strong><strong>*</strong></strong>输出log<strong><strong>**</strong></strong><br>检查补丁 test…<br>error: 当查询：<br>error: 打补丁失败：test:0<br>应用 test 个补丁，其中 1 个被拒绝…<br>拒绝第 #1 个片段。<br><strong><strong>*</strong></strong>输出log<strong><strong>**</strong></strong><br>这时候我们发现，文件夹多了一个test.rej的文件，打开它。<br>diff a/test b/test    (rejected hunks)<br>@@ -0,0 +1,5 @@<br>+11111<br>+22222<br>+33333<br>+44444<br>+55555<br>这个告诉我们，要在test中加入的信息，我们打开test补上就可以了。手动！<br>然后add / commit 就可以了。</p>
<p>作者：yotods<br>链接：<a href="http://www.jianshu.com/p/e5d801b936b6" target="_blank" rel="external">http://www.jianshu.com/p/e5d801b936b6</a><br>來源：简书<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>

            </div>
          

    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2015 -
    
    2017
    <span class="footer-author">MinusWang. All Rights Reserved. 砥砺前行-功不唐捐.</span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
